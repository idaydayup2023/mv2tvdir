# mv2tvdir

一个Python脚本，用于将电视剧文件（包括视频和字幕）移动到按剧名/季级组织的目录结构中。脚本能够区分电视剧和电影文件，并支持按分辨率和编码过滤文件。

当前版本：v1.0.3

## 功能

- 扫描源目录下的电视剧文件（支持mkv、mp4、avi视频格式和srt、ass、sub字幕格式）
- 区分电视剧和电影文件，只处理电视剧文件
- 支持按分辨率（如1080p、720p）和编码（如x265、x264）过滤文件
- 从文件名中提取剧名和季数信息
- 标准化文件名和目录名，将空格、()、[]等分隔符统一替换为点号(.)
- 按照"剧名/季级/电视剧"的结构创建目标目录
- 将文件移动到对应的目标目录
- **字幕文件对齐**：确保字幕文件只在对应的视频文件成功移动后才移动，支持一个视频文件对应多个字幕文件（如.srt、.ai.srt、.en.srt、.emb.srt等）

## 使用方法

```bash
./mv2tvdir.py <源目录> <目标目录> [选项]
```

或者

```bash
python3 mv2tvdir.py <源目录> <目标目录> [选项]
```

### 选项

- `--resolution=<分辨率>`: 只处理指定分辨率的文件 (例如: 1080p, 720p)
- `--codec=<编码>`: 只处理指定编码的文件 (例如: x265, x264)
- `--remove-source`: 在成功移动所有文件后删除源目录
- `--force`: 强制处理所有视频文件，忽略AI字幕检查（默认只处理有AI字幕的文件）
- `--no-override`: 不覆盖已存在的目标文件（默认会覆盖已存在的文件）
- `--version`: 显示版本信息

### 示例

基本用法：
```bash
./mv2tvdir.py /downloads /media/tv
```

只处理1080p分辨率的文件：
```bash
./mv2tvdir.py /downloads /media/tv --resolution=1080p
```

只处理x265编码的文件：
```bash
./mv2tvdir.py /downloads /media/tv --codec=x265
```

同时指定分辨率和编码：
```bash
./mv2tvdir.py /downloads /media/tv --resolution=1080p --codec=x265
```

移动文件后删除源目录：
```bash
./mv2tvdir.py /downloads /media/tv --remove-source
```

强制处理所有视频文件（忽略AI字幕检查）：
```bash
./mv2tvdir.py /downloads /media/tv --force
```

不覆盖已存在的目标文件：
```bash
./mv2tvdir.py /downloads /media/tv --no-override
```

组合使用多个选项（默认启用AI字幕检查）：
```bash
./mv2tvdir.py /downloads /media/tv --resolution=1080p --remove-source
```

## 文件命名格式

脚本支持的电视剧文件命名格式示例：

- Invasion.2021.S01E01.1080p.x265-ELiTE.mkv
- Breaking.Bad.S05E01.720p.HDTV.x264-IMMERSE.mp4

脚本会从文件名中提取剧名和季数，然后将文件移动到相应的目录中。

## AI字幕功能

**默认情况下**，脚本会检查每个视频文件是否存在对应的 `.ai.srt` 字幕文件。只有当视频文件存在对应的AI字幕文件时，该视频文件才会被处理和移动。

例如，对于视频文件 `Breaking.Bad.S01E01.1080p.x265.mkv`，脚本会检查是否存在 `Breaking.Bad.S01E01.1080p.x265.ai.srt` 字幕文件。如果存在，则处理该视频文件；如果不存在，则跳过该文件。

如果您想要处理所有视频文件（无论是否有AI字幕），可以使用 `--force` 选项来忽略AI字幕检查。

这个默认行为特别适用于只想处理已经生成了AI字幕的视频文件的场景。

## 字幕文件对齐功能

脚本采用两阶段处理机制来确保字幕文件与视频文件的严格对齐：

1. **第一阶段**：处理所有视频文件，记录成功移动的视频文件信息
2. **第二阶段**：处理字幕文件，只移动那些对应视频文件已成功移动的字幕文件

### 支持的字幕文件类型

脚本支持一个视频文件对应多个不同类型的字幕文件：

- `.srt` - 标准字幕文件
- `.ai.srt` - AI生成的字幕文件
- `.en.srt` - 英文字幕文件
- `.zh.srt` - 中文字幕文件
- `.emb.srt` - 内嵌字幕文件
- `.asr.srt` - 语音识别字幕文件
- `.ass` - Advanced SubStation Alpha格式
- `.sub` - 其他字幕格式

### 匹配逻辑

字幕文件通过文件名前缀匹配对应的视频文件。例如：

```
视频文件: Breaking.Bad.S01E01.1080p.x265.mkv
对应字幕文件:
├── Breaking.Bad.S01E01.1080p.x265.srt
├── Breaking.Bad.S01E01.1080p.x265.ai.srt
├── Breaking.Bad.S01E01.1080p.x265.en.srt
├── Breaking.Bad.S01E01.1080p.x265.emb.srt
└── Breaking.Bad.S01E01.1080p.x265.zh.srt
```

### 安全保障

- **孤立字幕文件保护**：没有对应视频文件的字幕文件不会被移动
- **失败回滚**：如果视频文件移动失败，对应的字幕文件也不会被移动
- **详细日志**：清楚记录每个文件的处理状态和原因

## 目录结构

脚本会创建以下目录结构：

```
目标目录/
├── 剧名1.名称/
│   ├── S01/
│   │   ├── 剧名1.名称.S01E01.视频文件
│   │   ├── 剧名1.名称.S01E01.字幕文件
│   │   └── ...
│   └── S02/
│       ├── 剧名1.名称.S02E01.视频文件
│       └── ...
└── 剧名2.名称/
    └── ...
```

## 日志

脚本会输出详细的日志信息，包括：

- 创建的目录
- 移动的文件
- 处理成功和失败的文件数量

## 要求

- Python 3.6+
- 无需额外依赖

## 许可证

本项目采用MIT许可证。详情请参阅[LICENSE](LICENSE)文件。